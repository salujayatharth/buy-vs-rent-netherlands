<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent vs. Buy Calculator - Netherlands</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-input {
            @apply w-20 p-1 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm text-right bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1;
        }
        .slider {
            @apply w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer;
        }
        .slider::-webkit-slider-thumb {
            @apply w-4 h-4 bg-indigo-600 dark:bg-indigo-500 rounded-full appearance-none cursor-pointer;
        }
        .slider::-moz-range-thumb {
            @apply w-4 h-4 bg-indigo-600 dark:bg-indigo-500 rounded-full border-0 cursor-pointer;
        }
        .tooltip {
            @apply relative inline-block cursor-help;
        }
        .tooltip .tooltiptext {
            @apply invisible w-64 bg-gray-800 dark:bg-gray-700 text-white dark:text-gray-200 text-left text-xs rounded-md py-2 px-3 absolute z-10 bottom-full left-1/2 -ml-32 opacity-0 transition-opacity duration-300 shadow-lg;
        }
        .tooltip:hover .tooltiptext {
            @apply visible opacity-100;
        }
        .details-section.hidden { display: none; }
        .table-container { max-height: 500px; overflow-y: auto; }
        .table-container thead tr:first-child th { position: sticky; top: 0; z-index: 10; background-color: rgb(229 231 235); }
        .table-container thead tr:first-child th.bg-blue-100 { background-color: rgb(219 234 254); }
        .table-container thead tr:first-child th.bg-green-100 { background-color: rgb(220 252 231); }
        .table-container thead tr:nth-child(2) th { position: sticky; top: 2.5rem; z-index: 10; background-color: rgb(243 244 246); }
        .sidebar {
             max-height: calc(100vh - 4rem); /* Adjust based on your header/footer height */
        }
        /* Smooth transitions for animated values */
        .animate-value {
            transition: all 0.3s ease-in-out;
        }
        .animate-color {
            transition: color 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }
        /* Smooth table updates */
        #yearlyDataTableBody {
            transition: opacity 0.2s ease-in-out;
        }
        /* Dark mode specific overrides */
        .dark .form-input {
            background-color: rgb(55 65 81); /* gray-700 */
            color: rgb(229 231 235); /* gray-200 */
            border-color: rgb(75 85 99); /* gray-600 */
        }
        .dark .table-container thead tr:first-child th { 
            background-color: rgb(55 65 81); 
        }
        .dark .table-container thead tr:first-child th.bg-blue-100 { 
            background-color: rgb(30 58 138); 
        }
        .dark .table-container thead tr:first-child th.bg-green-100 { 
            background-color: rgb(21 128 61); 
        }
        .dark .table-container thead tr:nth-child(2) th { 
            background-color: rgb(75 85 99); 
        }
        /* Theme toggle switch */
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: .4s;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .theme-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        input:checked + .theme-slider {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        input:checked + .theme-slider:before {
            transform: translateX(30px);
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }
        .theme-slider.round {
            border-radius: 30px;
        }
        .theme-slider.round:before {
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">
    <div class="container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-6">
            <div class="text-center flex-1">
                <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 dark:text-indigo-400">Interactive Rent vs. Buy Calculator</h1>
                <p class="text-lg text-gray-600 dark:text-gray-300">Netherlands Edition</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">ðŸŒž</span>
                    <label class="theme-toggle">
                        <input type="checkbox" id="themeToggle">
                        <span class="theme-slider round"></span>
                    </label>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">ðŸŒ™</span>
                </div>
                <button id="resetButton" class="bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg transition focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900">
                    Reset to Defaults
                </button>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Main Content: Summaries & Charts -->
            <main class="lg:w-3/4 w-full">
                <!-- Results Summary -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-6 rounded-lg shadow-lg dark:shadow-xl border border-blue-100 dark:border-blue-800">
                        <h3 class="text-xl font-semibold text-blue-700 dark:text-blue-300 mb-2">Renting Scenario</h3>
                        <p class="text-2xl font-bold text-blue-800 dark:text-blue-200 animate-value" id="rentMonthlyPayment">â‚¬0</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Monthly Payment (Year 1)</p>
                        <p class="text-3xl font-bold text-blue-600 dark:text-blue-300 animate-value" id="rentFinalNW">â‚¬0</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Projected Net Worth</p>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/30 p-6 rounded-lg shadow-lg dark:shadow-xl border border-green-100 dark:border-green-800">
                        <h3 class="text-xl font-semibold text-green-700 dark:text-green-300 mb-2">Buying Scenario</h3>
                        <p class="text-2xl font-bold text-green-800 dark:text-green-200 animate-value" id="buyMonthlyPayment">â‚¬0</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400 mb-3">Monthly Payment (Year 1)</p>
                        <p class="text-3xl font-bold text-green-600 dark:text-green-300 animate-value" id="buyFinalNW">â‚¬0</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Projected Net Worth (Equity)</p>
                    </div>
                </div>
                <div class="text-center mb-6 p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg shadow-lg dark:shadow-xl border border-indigo-100 dark:border-indigo-800">
                    <h3 class="text-xl font-semibold text-indigo-700 dark:text-indigo-300">Advantage After Time Horizon</h3>
                    <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-300 animate-value animate-color" id="rentingAdvantageValue">â‚¬0</p>
                </div>

                <!-- Charts -->
                <div class="space-y-6">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg dark:shadow-xl h-[280px] md:h-[300px]"><canvas id="netWorthChart"></canvas></div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg dark:shadow-xl h-[220px] md:h-[250px]"><canvas id="deltaChart"></canvas></div>
                </div>

            </main>

            <!-- Sidebar with Inputs -->
            <aside class="lg:w-1/4 w-full bg-white dark:bg-gray-800 p-5 rounded-xl shadow-xl dark:shadow-2xl sidebar overflow-y-auto border border-gray-100 dark:border-gray-700">
                <div class="space-y-5">
                    <!-- Common Assumptions -->
                    <div class="p-4 border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 rounded-lg"><h3 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-200 border-b border-gray-200 dark:border-gray-600 pb-2">Common Assumptions</h3><div id="timeHorizon-container"></div></div>
                    <!-- Buy Scenario -->
                    <div class="p-4 border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 rounded-lg"><h3 class="text-lg font-semibold mb-3 text-green-700 dark:text-green-400 border-b border-gray-200 dark:border-gray-600 pb-2">â–¼ Buy Scenario</h3><div class="space-y-4"><div id="purchasePrice-container"></div><div id="downPayment-container"></div><div id="mortgageInterestRate-container"></div><div id="amortization-container"></div><div id="propertyTaxRate-container"></div><div id="maintenanceCosts-container"></div><div id="vveRate-container"></div><fieldset class="text-sm text-gray-600 dark:text-gray-300"><legend class="form-label -mb-1">Costs Based On:</legend><label class="mr-3"><input type="radio" name="maintenanceBasis" value="original" class="mr-1">Original Price</label><label><input type="radio" name="maintenanceBasis" value="current" checked class="mr-1">Current Value</label></fieldset><div id="propertyAppreciationRate-container"></div><div id="otherBuyerCostsRate-container"></div><div id="effectiveMarginalTaxRate-container"></div></div></div>
                    <!-- Rent Scenario -->
                    <div class="p-4 border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/50 rounded-lg"><h3 class="text-lg font-semibold mb-3 text-blue-700 dark:text-blue-400 border-b border-gray-200 dark:border-gray-600 pb-2">â–¼ Rent Scenario</h3><div class="space-y-4"><div id="monthlyRent-container"></div><div id="annualRentIncrease-container"></div><div id="investmentReturnRate-container"></div><fieldset class="mt-2"><legend class="form-label tooltip">Investment Tax (Box 3)<span class="tooltiptext">Tax on net assets (savings/investments) above a threshold (heffingsvrij vermogen, approx â‚¬57k/person). Simplified here.</span></legend><div class="flex items-center space-x-4 text-sm"><label class="text-gray-600 dark:text-gray-300"><input type="radio" name="investmentTax" value="taxFree" class="mr-1"> Tax-Free</label><label class="text-gray-600 dark:text-gray-300"><input type="radio" name="investmentTax" value="taxable" checked class="mr-1"> Taxable</label></div></fieldset></div></div>
                </div>
            </aside>
        </div>

        <!-- Calculation Details & Table - Full Width Section -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl dark:shadow-2xl mt-8 border border-gray-100 dark:border-gray-700">
            <button id="toggleDetailsButton" class="w-full text-left font-semibold text-indigo-600 dark:text-indigo-400 p-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition focus:outline-none border border-indigo-100 dark:border-indigo-800">Show Key Totals Breakdown <span id="detailsArrow">â–¼</span></button>
            <div id="detailsSection" class="details-section hidden mt-4 p-6 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg">
                <!-- Details Content -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold text-green-700 dark:text-green-400 mb-4 border-b border-green-200 dark:border-green-700 pb-2">Buying Breakdown</h3>
                        <div class="space-y-2 text-sm">
                            <p class="flex justify-between text-gray-700 dark:text-gray-300"><span>Initial Upfront Costs:</span><strong class="animate-value" id="detailUpfrontCosts">â‚¬0</strong></p>
                            <p class="flex justify-between text-gray-700 dark:text-gray-300"><span>Initial Loan Amount:</span><strong class="animate-value" id="detailLoanAmount">â‚¬0</strong></p>
                            <p class="flex justify-between text-gray-700 dark:text-gray-300"><span>Monthly Mortgage (P&I):</span><strong class="animate-value" id="detailMonthlyMortgage">â‚¬0</strong></p>
                            <hr class="my-2 border-gray-300 dark:border-gray-600">
                            <h4 class="font-semibold text-gray-600 dark:text-gray-400 pt-1">Total Costs Over Period</h4>
                            <p class="flex justify-between pl-2 text-gray-700 dark:text-gray-300"><span>Mortgage Interest Paid:</span><strong class="animate-value" id="detailTotalInterest">â‚¬0</strong></p>
                            <p class="flex justify-between pl-2 text-green-600 dark:text-green-400"><span>Tax Deduction Benefit:</span><strong class="animate-value" id="detailTotalDeduction">â‚¬0</strong></p>
                            <p class="flex justify-between pl-2 text-gray-700 dark:text-gray-300"><span>Property Tax (OZB):</span><strong class="animate-value" id="detailTotalOzb">â‚¬0</strong></p>
                            <p class="flex justify-between pl-2 text-gray-700 dark:text-gray-300"><span>Maintenance:</span><strong class="animate-value" id="detailTotalMaintenance">â‚¬0</strong></p>
                            <p class="flex justify-between pl-2 text-gray-700 dark:text-gray-300"><span>VvE Fees:</span><strong class="animate-value" id="detailTotalVve">â‚¬0</strong></p>
                            <hr class="my-2 border-gray-300 dark:border-gray-600">
                            <h4 class="font-semibold text-gray-600 dark:text-gray-400 pt-1">Final Outcome</h4>
                            <p class="flex justify-between text-gray-700 dark:text-gray-300"><span>Final Home Value:</span><strong class="animate-value" id="detailFinalHomeValue">â‚¬0</strong></p>
                            <p class="flex justify-between text-gray-700 dark:text-gray-300"><span>Final Loan Balance:</span><strong class="animate-value" id="detailFinalLoanBalance">â‚¬0</strong></p>
                            <p class="flex justify-between font-bold text-base pt-1 text-gray-800 dark:text-gray-200"><span>Final Equity (Net Worth):</span><strong class="animate-value" id="detailFinalEquity">â‚¬0</strong></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-blue-700 dark:text-blue-400 mb-4 border-b border-blue-200 dark:border-blue-700 pb-2">Renting Breakdown</h3>
                        <div class="space-y-2 text-sm">
                            <p class="flex justify-between text-gray-700 dark:text-gray-300"><span>Initial Investment:</span><strong class="animate-value" id="detailInitialInvestment">â‚¬0</strong></p>
                            <p class="flex justify-between text-gray-700 dark:text-gray-300"><span>Extra Cash Invested:</span><strong class="animate-value" id="detailTotalCashInvested">â‚¬0</strong></p>
                            <p class="flex justify-between text-gray-700 dark:text-gray-300"><span>Investment Growth:</span><strong class="animate-value" id="detailTotalGrowth">â‚¬0</strong></p>
                            <hr class="my-2 border-gray-300 dark:border-gray-600">
                            <h4 class="font-semibold text-gray-600 dark:text-gray-400 pt-1">Total Costs Over Period</h4>
                            <p class="flex justify-between pl-2 text-gray-700 dark:text-gray-300"><span>Total Rent Paid:</span><strong class="animate-value" id="detailTotalRent">â‚¬0</strong></p>
                            <p class="flex justify-between pl-2 text-gray-700 dark:text-gray-300"><span>Wealth Tax Paid (Box 3):</span><strong class="animate-value" id="detailTotalWealthTax">â‚¬0</strong></p>
                            <hr class="my-2 border-gray-300 dark:border-gray-600">
                            <h4 class="font-semibold text-gray-600 dark:text-gray-400 pt-1">Final Outcome</h4>
                            <p class="flex justify-between font-bold text-base pt-1 text-gray-800 dark:text-gray-200"><span>Final Investments (Net Worth):</span><strong class="animate-value" id="detailFinalInvestments">â‚¬0</strong></p>
                        </div>
                    </div>
                </div>
            </div>
            <button id="toggleYearlyDataButton" class="w-full text-left font-semibold text-indigo-600 dark:text-indigo-400 p-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition focus:outline-none mt-4 border border-indigo-100 dark:border-indigo-800">Show Yearly Data Breakdown <span id="yearlyDataArrow">â–¼</span></button>
            <div id="yearlyDataSection" class="details-section hidden mt-4 p-4 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg">
                <!-- Yearly Data Table -->
                <div class="table-container">
                    <table class="w-full text-sm text-left text-gray-600 dark:text-gray-300 whitespace-nowrap">
                        <thead class="text-xs text-gray-700 dark:text-gray-200 uppercase bg-gray-200 dark:bg-gray-700">
                            <tr>
                                <th rowspan="2" class="py-3 px-4 align-bottom">Year</th>
                                <th colspan="5" class="py-2 px-4 text-center border-b border-l border-gray-300 dark:border-gray-600 bg-blue-100 dark:bg-blue-900/50">Renter Details</th>
                                <th colspan="9" class="py-2 px-4 text-center border-b border-l border-gray-300 dark:border-gray-600 bg-green-100 dark:bg-green-900/50">Buyer Details</th>
                                <th rowspan="2" class="py-3 px-4 align-bottom border-l border-gray-300 dark:border-gray-600"><span class="tooltip">Advantage<span class="tooltiptext w-72">Compares the final net worth of both scenarios.<br><br><strong>Formula:</strong><br>Renter Net Worth - Buyer Net Worth<br><br>A positive value means renting is financially better. A negative value means buying is better.</span></span></th>
                            </tr>
                            <tr class="bg-gray-100 dark:bg-gray-800">
                                <th class="py-2 px-3 border-l border-gray-300 dark:border-gray-600">Monthly Rent</th><th class="py-2 px-3">Yearly Rent</th><th class="py-2 px-3">Yearly Invested</th><th class="py-2 px-3">Growth</th><th class="py-2 px-3">Net Worth</th>
                                <th class="py-2 px-3 border-l border-gray-300 dark:border-gray-600">House Value</th><th class="py-2 px-3">EMI (P&I)</th><th class="py-2 px-3">Interest</th><th class="py-2 px-3">Deduction</th><th class="py-2 px-3">Net Interest</th><th class="py-2 px-3">Property Tax</th><th class="py-2 px-3">Maintenance</th><th class="py-2 px-3">VvE</th><th class="py-2 px-3">Net Worth</th>
                            </tr>
                        </thead>
                        <tbody id="yearlyDataTableBody"></tbody>
                    </table>
                </div>
                <div class="mt-4 text-center">
                    <button id="exportCsvButton" class="bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg transition focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                        Export as CSV
                    </button>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 py-4 border-t border-gray-200 dark:border-gray-700">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                <a href="https://github.com/salujayatharth/nl-buy-vs-rent" target="_blank" rel="noopener noreferrer" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 transition-colors">
                    View on GitHub
                </a>
            </p>
            <p class="text-sm text-gray-500 dark:text-gray-400">Disclaimer: This calculator is for illustrative purposes only and not financial advice.</p>
        </footer>
    </div>

    <script>
        // --- Constants & Globals ---
        const TRANSFER_TAX_RATE = 0.02; 
        const BOX3_TAX_FREE_THRESHOLD = 0;
        let netWorthChart, deltaChart;
        let animationTimeout = null;
        let currentYearlyData = []; // Store current yearly data for CSV export

        // --- Theme Management ---
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = savedTheme === 'dark' || (!savedTheme && true); // Default to dark mode
            
            if (prefersDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('themeToggle').checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('themeToggle').checked = false;
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            
            if (isDark) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('themeToggle').checked = false;
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('themeToggle').checked = true;
            }
            
            // Update chart colors if charts exist
            updateChartColors();
        }

        function updateChartColors() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            
            if (netWorthChart) {
                netWorthChart.options.scales.x.ticks.color = textColor;
                netWorthChart.options.scales.y.ticks.color = textColor;
                netWorthChart.options.scales.x.grid.color = gridColor;
                netWorthChart.options.scales.y.grid.color = function(context) {
                    return context.tick.value === 0 ? (isDark ? '#6b7280' : '#374151') : gridColor;
                };
                netWorthChart.options.plugins.legend.labels.color = textColor;
                netWorthChart.update('none');
            }
            
            if (deltaChart) {
                deltaChart.options.scales.x.ticks.color = textColor;
                deltaChart.options.scales.y.ticks.color = textColor;
                deltaChart.options.scales.x.grid.color = gridColor;
                deltaChart.options.scales.y.grid.color = function(context) {
                    return context.tick.value === 0 ? (isDark ? '#6b7280' : '#374151') : gridColor;
                };
                deltaChart.options.plugins.legend.labels.color = textColor;
                deltaChart.update('none');
            }
        }

        // Animation helper functions
        function animateNumber(element, targetValue, duration = 300) {
            const startValue = parseFloat(element.textContent.replace(/[â‚¬.,]/g, '')) || 0;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease-out animation curve
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const currentValue = startValue + (targetValue - startValue) * easeProgress;
                
                element.textContent = formatCurrency(currentValue);
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        function animateTextWithColor(element, targetText, targetClass, duration = 300) {
            // Smooth transition for text and color changes
            element.style.transition = 'opacity 0.15s ease-in-out';
            element.style.opacity = '0.6';
            
            setTimeout(() => {
                element.textContent = targetText;
                element.className = targetClass + ' animate-value animate-color';
                element.style.opacity = '1';
            }, 150);
        }

        // --- DOM Elements ---
        const el = (id) => document.getElementById(id);
        const rentFinalNWEl = el('rentFinalNW'), buyFinalNWEl = el('buyFinalNW');
        const rentMonthlyPaymentEl = el('rentMonthlyPayment'), buyMonthlyPaymentEl = el('buyMonthlyPayment');
        const rentingAdvantageValueEl = el('rentingAdvantageValue');
        const toggleDetailsButton = el('toggleDetailsButton'), detailsSection = el('detailsSection'), detailsArrow = el('detailsArrow');
        const toggleYearlyDataButton = el('toggleYearlyDataButton'), yearlyDataSection = el('yearlyDataSection'), yearlyDataArrow = el('yearlyDataArrow');
        const yearlyDataTableBody = el('yearlyDataTableBody');
        const exportCsvButton = el('exportCsvButton');
        const resetButton = el('resetButton');
        const detailValueElements = { 
            upfrontCosts: el('detailUpfrontCosts'), loanAmount: el('detailLoanAmount'), monthlyMortgage: el('detailMonthlyMortgage'), 
            finalHomeValue: el('detailFinalHomeValue'), finalLoanBalance: el('detailFinalLoanBalance'), finalEquity: el('detailFinalEquity'), 
            initialInvestment: el('detailInitialInvestment'), totalCashInvested: el('detailTotalCashInvested'), totalGrowth: el('detailTotalGrowth'), 
            totalWealthTax: el('detailTotalWealthTax'), finalInvestments: el('detailFinalInvestments'),
            totalInterest: el('detailTotalInterest'), totalDeduction: el('detailTotalDeduction'), totalOzb: el('detailTotalOzb'),
            totalMaintenance: el('detailTotalMaintenance'), totalVve: el('detailTotalVve'), totalRent: el('detailTotalRent')
        };

        // --- Input Definitions ---
        const inputsConfig = {
            timeHorizon: { label: 'Time Horizon (Years)', container: 'timeHorizon-container', min: 1, max: 50, step: 1, value: 30, unit: 'yrs' },
            purchasePrice: { label: 'Purchase Price (â‚¬)', container: 'purchasePrice-container', min: 50000, max: 3000000, step: 10000, value: 800000, unit: 'â‚¬' },
            downPayment: { label: 'Down Payment (%)', container: 'downPayment-container', min: 0, max: 100, step: 0.1, value: 0, unit: '%' },
            mortgageInterestRate: { label: 'Mortgage Interest Rate (%)', container: 'mortgageInterestRate-container', min: 0.5, max: 10, step: 0.01, value: 4.0, unit: '%' },
            amortization: { label: 'Amortization (Years)', container: 'amortization-container', min: 10, max: 40, step: 1, value: 30, unit: 'yrs' },
            propertyTaxRate: { label: 'OZB (Property Tax %)', container: 'propertyTaxRate-container', min: 0.01, max: 0.5, step: 0.001, value: 0.06, unit: '%' },
            maintenanceCosts: { label: 'Maintenance (%/Year)', container: 'maintenanceCosts-container', min: 0, max: 5, step: 0.1, value: 1.0, unit: '%' },
            vveRate: { label: 'VvE / HOA Fees (%/Year)', container: 'vveRate-container', min: 0, max: 0.5, step: 0.001, value: 0.03, unit: '%' },
            propertyAppreciationRate: { label: 'Property Appreciation (%/Year)', container: 'propertyAppreciationRate-container', min: -5, max: 15, step: 0.1, value: 7.0, unit: '%' },
            otherBuyerCostsRate: { label: 'Other Buyer Costs (%)', container: 'otherBuyerCostsRate-container', min: 0, max: 10, step: 0.1, value: 2.0, unit: '%' },
            effectiveMarginalTaxRate: { label: 'Marginal Tax Rate (%)', container: 'effectiveMarginalTaxRate-container', min: 0, max: 60, step: 0.1, value: 37.0, unit: '%' },
            monthlyRent: { label: 'Monthly Rent (â‚¬)', container: 'monthlyRent-container', min: 500, max: 10000, step: 50, value: 2700, unit: 'â‚¬' },
            annualRentIncrease: { label: 'Annual Rent Increase (%)', container: 'annualRentIncrease-container', min: 0, max: 10, step: 0.1, value: 2.9, unit: '%' },
            investmentReturnRate: { label: 'Investment Return (%/Year)', container: 'investmentReturnRate-container', min: 0, max: 25, step: 0.1, value: 14.0, unit: '%' },
        };

        // --- Functions ---
        function createSliderInput(id, config) {
            const container = el(config.container);
            container.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <label for="${id}-slider" class="form-label">${config.label}</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="${id}-number" min="${config.min}" max="${config.max}" step="${config.step}" value="${config.value}" class="form-input">
                        <span class="text-xs text-gray-500 dark:text-gray-400">${config.unit}</span>
                    </div>
                </div>
                <input type="range" id="${id}-slider" min="${config.min}" max="${config.max}" step="${config.step}" value="${config.value}" class="slider">
            `;
        }

        function setupInputListeners() {
            Object.keys(inputsConfig).forEach(id => {
                const slider = el(`${id}-slider`);
                const number = el(`${id}-number`);
                slider.addEventListener('input', () => {
                    number.value = slider.value;
                    debouncedCalculateResults();
                });
                number.addEventListener('change', () => {
                    slider.value = number.value;
                    debouncedCalculateResults();
                });
            });
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', debouncedCalculateResults);
            });
        }

        function debouncedCalculateResults() {
            if (animationTimeout) {
                clearTimeout(animationTimeout);
            }
            animationTimeout = setTimeout(() => {
                calculateResults();
                saveToLocalStorage(); // Save values after calculation
            }, 30); // Reduced delay for more responsive feel while still preventing excessive calculations
        }

        function getInputs() {
            const values = {};
            for (const id in inputsConfig) {
                values[id] = parseFloat(el(`${id}-number`).value) || 0;
            }
            values.maintenanceBasis = document.querySelector('input[name="maintenanceBasis"]:checked').value;
            values.investmentTaxType = document.querySelector('input[name="investmentTax"]:checked').value;
            return values;
        }

        function formatCurrency(value) { return value.toLocaleString('nl-NL', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
        function calculateMonthlyMortgage(p, r, t) { if (r <= 0 || t <= 0 || p <= 0) return 0; const monthlyRate = r / 12; const n = t * 12; return p * (monthlyRate * Math.pow(1 + monthlyRate, n)) / (Math.pow(1 + monthlyRate, n) - 1); }

        // --- LocalStorage Functions ---
        const STORAGE_KEY = 'nl-buy-vs-rent-calculator';
        
        function saveToLocalStorage() {
            try {
                const values = getInputs();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(values));
            } catch (error) {
                console.warn('Could not save to localStorage:', error);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (error) {
                console.warn('Could not load from localStorage:', error);
            }
            return null;
        }
        
        function clearLocalStorage() {
            try {
                localStorage.removeItem(STORAGE_KEY);
            } catch (error) {
                console.warn('Could not clear localStorage:', error);
            }
        }
        
        function applyStoredValues(values) {
            // Apply slider/number inputs
            Object.keys(inputsConfig).forEach(id => {
                if (values[id] !== undefined) {
                    const slider = el(`${id}-slider`);
                    const number = el(`${id}-number`);
                    if (slider && number) {
                        slider.value = values[id];
                        number.value = values[id];
                    }
                }
            });
            
            // Apply radio buttons
            if (values.maintenanceBasis) {
                const radio = document.querySelector(`input[name="maintenanceBasis"][value="${values.maintenanceBasis}"]`);
                if (radio) radio.checked = true;
            }
            
            if (values.investmentTaxType) {
                const radio = document.querySelector(`input[name="investmentTax"][value="${values.investmentTaxType}"]`);
                if (radio) radio.checked = true;
            }

        }

        function exportToCsv() {
            if (currentYearlyData.length === 0) {
                alert('No data to export. Please ensure calculations have been performed.');
                return;
            }

            // Define CSV headers
            const headers = [
                'Year',
                'Monthly Rent (â‚¬)',
                'Yearly Rent (â‚¬)',
                'Yearly Invested (â‚¬)',
                'Investment Growth (â‚¬)',
                'Renter Net Worth (â‚¬)',
                'House Value (â‚¬)',
                'EMI P&I (â‚¬)',
                'Interest Paid (â‚¬)',
                'Tax Deduction (â‚¬)',
                'Net Interest Cost (â‚¬)',
                'Property Tax (â‚¬)',
                'Maintenance (â‚¬)',
                'VvE Fees (â‚¬)',
                'Buyer Net Worth (â‚¬)',
                'Advantage (â‚¬)'
            ];

            // Convert data to CSV format
            const csvRows = [headers.join(',')];
            
            currentYearlyData.forEach(item => {
                const row = [
                    item.year,
                    Math.round(item.house_rent_pm),
                    Math.round(item.yearly_rent),
                    Math.round(item.yearly_invested),
                    Math.round(item.investment_growth),
                    Math.round(item.renter_net_worth),
                    Math.round(item.house_value),
                    Math.round(item.yearly_costs_p_i),
                    Math.round(item.yearly_interest),
                    Math.round(item.tax_deduction),
                    Math.round(item.net_interest_cost),
                    Math.round(item.property_tax),
                    Math.round(item.maintenance),
                    Math.round(item.vve),
                    Math.round(item.buyer_net_worth),
                    Math.round(item.advantage)
                ];
                csvRows.push(row.join(','));
            });

            // Create CSV content
            const csvContent = csvRows.join('\n');
            
            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'rent_vs_buy_yearly_breakdown.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function calculateResults() {
            const inputs = getInputs();
            if (inputs.timeHorizon <= 0) return;

            const buyerNetWorthTimeline = [0];
            const renterNetWorthTimeline = [0];
            const labels = ['Year 0'];
            const yearlyData = [];

            const purchasePrice = inputs.purchasePrice;
            const downPaymentAmount = purchasePrice * (inputs.downPayment / 100);
            const loanAmount = purchasePrice - downPaymentAmount;
            const transferTaxAmount = purchasePrice * TRANSFER_TAX_RATE;
            const otherBuyerCostsAmount = purchasePrice * (inputs.otherBuyerCostsRate / 100);
            const totalUpfrontBuyerCosts = downPaymentAmount + transferTaxAmount + otherBuyerCostsAmount;

            const monthlyMortgagePayment = calculateMonthlyMortgage(loanAmount, inputs.mortgageInterestRate / 100, inputs.amortization);

            let currentHomeValue = purchasePrice;
            let currentLoanBalance = loanAmount;
            let renterInvestedAssets = totalUpfrontBuyerCosts;
            let currentMonthlyRent = inputs.monthlyRent;
            
            let totalWealthTaxPaid = 0, totalExtraCashInvestedByRenter = 0, totalInvestmentGrowth = 0, totalRentPaid = 0;
            let totalInterestPaid = 0, totalDeductionBenefit = 0, totalOzbPaid = 0, totalMaintenancePaid = 0, totalVvePaid = 0;


            buyerNetWorthTimeline[0] = currentHomeValue - currentLoanBalance;
            renterNetWorthTimeline[0] = renterInvestedAssets;
            
            // Calculate first year monthly payments for display in headers
            const firstYearRentMonthly = currentMonthlyRent;
            
            // Calculate first year buyer costs (similar to year 1 in the loop below)
            let firstYearInterest = 0, firstYearPrincipal = 0;
            let tempLoanBalance = loanAmount;
            
            if (tempLoanBalance > 0) {
                for (let month = 1; month <= 12; month++) {
                    if (tempLoanBalance <= 0) break;
                    const monthlyInterest = tempLoanBalance * ((inputs.mortgageInterestRate / 100) / 12);
                    let monthlyPrincipal = monthlyMortgagePayment - monthlyInterest;
                    if (monthlyPrincipal > tempLoanBalance) { monthlyPrincipal = tempLoanBalance; }
                    firstYearInterest += monthlyInterest;
                    firstYearPrincipal += monthlyPrincipal;
                    tempLoanBalance -= monthlyPrincipal;
                }
            }
            
            const firstYearHomeValue = purchasePrice * (1 + (inputs.propertyAppreciationRate / 100));
            const firstYearRecurringCostBase = inputs.maintenanceBasis === 'current' ? firstYearHomeValue : purchasePrice;
            const firstYearMaintenanceCost = firstYearRecurringCostBase * (inputs.maintenanceCosts / 100);
            const firstYearVveCost = firstYearRecurringCostBase * (inputs.vveRate / 100);
            const firstYearOzbCost = firstYearHomeValue * (inputs.propertyTaxRate / 100);
            const firstYearDeductionBenefit = firstYearInterest * (inputs.effectiveMarginalTaxRate / 100);
            const firstYearMortgagePayment = firstYearPrincipal + firstYearInterest;
            const firstYearBuyerCashOutflow = firstYearMortgagePayment + firstYearOzbCost + firstYearMaintenanceCost + firstYearVveCost - firstYearDeductionBenefit;
            const firstYearBuyMonthly = firstYearBuyerCashOutflow / 12;
            
            for (let year = 1; year <= inputs.timeHorizon; year++) {
                labels.push(`Year ${year}`);
                let interestPaidThisYear = 0, principalPaidThisYear = 0;
                
                if (currentLoanBalance > 0 && year <= inputs.amortization) {
                    for (let month = 1; month <= 12; month++) {
                        if (currentLoanBalance <= 0) break;
                        const monthlyInterest = currentLoanBalance * ((inputs.mortgageInterestRate / 100) / 12);
                        let monthlyPrincipal = monthlyMortgagePayment - monthlyInterest;
                        if (monthlyPrincipal > currentLoanBalance) { monthlyPrincipal = currentLoanBalance; }
                        interestPaidThisYear += monthlyInterest; principalPaidThisYear += monthlyPrincipal; currentLoanBalance -= monthlyPrincipal;
                    }
                }
                if (currentLoanBalance < 0) currentLoanBalance = 0;
                
                currentHomeValue *= (1 + (inputs.propertyAppreciationRate / 100));
                
                const recurringCostBaseValue = inputs.maintenanceBasis === 'current' ? currentHomeValue : purchasePrice;
                const maintenanceCost = recurringCostBaseValue * (inputs.maintenanceCosts / 100);
                const vveCost = recurringCostBaseValue * (inputs.vveRate / 100);
                const ozbCost = currentHomeValue * (inputs.propertyTaxRate / 100);
                const mortgageInterestDeductionBenefit = (year <= inputs.amortization) ? (interestPaidThisYear * (inputs.effectiveMarginalTaxRate / 100)) : 0;
                const actualAnnualMortgagePayment = principalPaidThisYear + interestPaidThisYear;
                const buyerAnnualCashOutflow = actualAnnualMortgagePayment + ozbCost + maintenanceCost + vveCost - mortgageInterestDeductionBenefit;
                
                totalInterestPaid += interestPaidThisYear;
                totalDeductionBenefit += mortgageInterestDeductionBenefit;
                totalOzbPaid += ozbCost;
                totalMaintenancePaid += maintenanceCost;
                totalVvePaid += vveCost;

                const currentBuyerNetWorth = currentHomeValue - currentLoanBalance;
                buyerNetWorthTimeline.push(currentBuyerNetWorth);

                const renterAnnualCashOutflow = currentMonthlyRent * 12;
                totalRentPaid += renterAnnualCashOutflow;

                const cashFlowDifferenceRenterVsBuyer = buyerAnnualCashOutflow - renterAnnualCashOutflow;
                renterInvestedAssets += cashFlowDifferenceRenterVsBuyer;
                totalExtraCashInvestedByRenter += cashFlowDifferenceRenterVsBuyer;
                
                const investmentReturn = renterInvestedAssets * (inputs.investmentReturnRate / 100);
                renterInvestedAssets += investmentReturn;
                totalInvestmentGrowth += investmentReturn;

                if (inputs.investmentTaxType === 'taxable' && renterInvestedAssets > BOX3_TAX_FREE_THRESHOLD) {
                    const wealthTax = (renterInvestedAssets - BOX3_TAX_FREE_THRESHOLD) * 0.015;
                    renterInvestedAssets -= wealthTax; totalWealthTaxPaid += wealthTax;
                }
                renterNetWorthTimeline.push(renterInvestedAssets);
                
                yearlyData.push({ year, house_rent_pm: currentMonthlyRent, yearly_rent: renterAnnualCashOutflow, yearly_invested: cashFlowDifferenceRenterVsBuyer, investment_growth: investmentReturn, renter_net_worth: renterInvestedAssets, house_value: currentHomeValue, yearly_costs_p_i: actualAnnualMortgagePayment, yearly_interest: interestPaidThisYear, tax_deduction: mortgageInterestDeductionBenefit, net_interest_cost: interestPaidThisYear - mortgageInterestDeductionBenefit, property_tax: ozbCost, maintenance: maintenanceCost, vve: vveCost, buyer_net_worth: currentBuyerNetWorth, advantage: renterInvestedAssets - currentBuyerNetWorth });
                currentMonthlyRent *= (1 + (inputs.annualRentIncrease / 100));
            }

            const deltaNetWorthTimeline = renterNetWorthTimeline.map((rentNW, i) => rentNW - buyerNetWorthTimeline[i]);
            const finalRentNW = renterNetWorthTimeline[inputs.timeHorizon];
            const finalBuyNW = buyerNetWorthTimeline[inputs.timeHorizon];
            const advantage = finalRentNW - finalBuyNW;
            
            // Animate the main summary values with smooth transitions
            animateNumber(rentFinalNWEl, finalRentNW);
            animateNumber(buyFinalNWEl, finalBuyNW);
            
            // Animate the monthly payment values
            animateNumber(rentMonthlyPaymentEl, firstYearRentMonthly);
            animateNumber(buyMonthlyPaymentEl, firstYearBuyMonthly);
            
            // Animate the advantage text and color change
            const advantageText = advantage >= 0 ? `Renting is better by ${formatCurrency(advantage)}` : `Buying is better by ${formatCurrency(Math.abs(advantage))}`;
            const advantageClass = advantage >= 0 ? "text-3xl font-bold text-blue-600" : "text-3xl font-bold text-green-600";
            animateTextWithColor(rentingAdvantageValueEl, advantageText, advantageClass);
            
            // Update all detail fields with animation
            animateNumber(detailValueElements.upfrontCosts, totalUpfrontBuyerCosts);
            animateNumber(detailValueElements.loanAmount, loanAmount);
            animateNumber(detailValueElements.monthlyMortgage, monthlyMortgagePayment);
            animateNumber(detailValueElements.finalHomeValue, currentHomeValue);
            animateNumber(detailValueElements.finalLoanBalance, currentLoanBalance);
            animateNumber(detailValueElements.finalEquity, finalBuyNW);
            animateNumber(detailValueElements.initialInvestment, totalUpfrontBuyerCosts);
            animateNumber(detailValueElements.totalCashInvested, totalExtraCashInvestedByRenter);
            animateNumber(detailValueElements.totalGrowth, totalInvestmentGrowth);
            animateNumber(detailValueElements.totalWealthTax, totalWealthTaxPaid);
            animateNumber(detailValueElements.finalInvestments, finalRentNW);
            animateNumber(detailValueElements.totalInterest, totalInterestPaid);
            animateNumber(detailValueElements.totalDeduction, totalDeductionBenefit);
            animateNumber(detailValueElements.totalOzb, totalOzbPaid);
            animateNumber(detailValueElements.totalMaintenance, totalMaintenancePaid);
            animateNumber(detailValueElements.totalVve, totalVvePaid);
            animateNumber(detailValueElements.totalRent, totalRentPaid);


            updateChart(labels, buyerNetWorthTimeline, renterNetWorthTimeline);
            updateDeltaChart(labels, deltaNetWorthTimeline);
            populateYearlyTable(yearlyData);
            
            // Store yearly data for CSV export
            currentYearlyData = yearlyData;
        }

        function populateYearlyTable(data) {
            // Add fade effect during table update
            yearlyDataTableBody.style.opacity = '0.7';
            
            setTimeout(() => {
                yearlyDataTableBody.innerHTML = '';
                data.forEach(item => {
                    const isDark = document.documentElement.classList.contains('dark');
                    const advantageClass = item.advantage >= 0 ? (isDark ? 'text-blue-400' : 'text-blue-600') : (isDark ? 'text-green-400' : 'text-green-600');
                    const row = document.createElement('tr');
                    row.className = `bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 text-right`;
                    row.innerHTML = `<td class="py-2 px-4 font-medium text-gray-900 dark:text-gray-100 text-center">${item.year}</td><td class="py-2 px-3 border-l border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200">${formatCurrency(item.house_rent_pm)}</td><td class="py-2 px-3 text-gray-900 dark:text-gray-200">${formatCurrency(item.yearly_rent)}</td><td class="py-2 px-3 text-gray-900 dark:text-gray-200">${formatCurrency(item.yearly_invested)}</td><td class="py-2 px-3 text-gray-900 dark:text-gray-200">${formatCurrency(item.investment_growth)}</td><td class="py-2 px-3 font-semibold text-gray-900 dark:text-gray-100">${formatCurrency(item.renter_net_worth)}</td><td class="py-2 px-3 border-l border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-200">${formatCurrency(item.house_value)}</td><td class="py-2 px-3 text-gray-900 dark:text-gray-200">${formatCurrency(item.yearly_costs_p_i)}</td><td class="py-2 px-3 text-gray-900 dark:text-gray-200">${formatCurrency(item.yearly_interest)}</td><td class="py-2 px-3 text-green-600 dark:text-green-400">${formatCurrency(item.tax_deduction)}</td><td class="py-2 px-3 text-gray-900 dark:text-gray-200">${formatCurrency(item.net_interest_cost)}</td><td class="py-2 px-3 text-gray-900 dark:text-gray-200">${formatCurrency(item.property_tax)}</td><td class="py-2 px-3 text-gray-900 dark:text-gray-200">${formatCurrency(item.maintenance)}</td><td class="py-2 px-3 text-gray-900 dark:text-gray-200">${formatCurrency(item.vve)}</td><td class="py-2 px-3 font-semibold text-gray-900 dark:text-gray-100">${formatCurrency(item.buyer_net_worth)}</td><td class="py-2 px-4 font-semibold border-l border-gray-300 dark:border-gray-600 ${advantageClass}">${formatCurrency(item.advantage)}</td>`;
                    yearlyDataTableBody.appendChild(row);
                });
                
                // Fade back in
                yearlyDataTableBody.style.opacity = '1';
            }, 100);
        }
        
        function updateChart(labels, buyData, rentData) {
            const ctx = document.getElementById('netWorthChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            
            if (netWorthChart) {
                // Update existing chart data with animation
                netWorthChart.data.labels = labels;
                netWorthChart.data.datasets[0].data = buyData;
                netWorthChart.data.datasets[1].data = rentData;
                netWorthChart.update('active');
            } else {
                // Create new chart with animation enabled
                netWorthChart = new Chart(ctx, {
                    type: 'line', 
                    data: { 
                        labels, 
                        datasets: [ 
                            { label: 'Buying Net Worth (Equity)', data: buyData, borderColor: 'rgb(22, 163, 74)', backgroundColor: 'rgba(22, 163, 74, 0.1)', fill: true, tension: 0.1 }, 
                            { label: 'Renting Net Worth (Investments)', data: rentData, borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.1 }
                        ] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        animation: {
                            duration: 400,
                            easing: 'easeInOutQuad'
                        },
                        scales: { 
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            y: { 
                                ticks: { 
                                    color: textColor,
                                    callback: (value) => formatCurrency(value) 
                                },
                                grid: { color: gridColor }
                            }
                        }, 
                        plugins: { 
                            legend: { 
                                position: 'top',
                                labels: { color: textColor }
                            }, 
                            title: { 
                                display: true, 
                                text: 'Projected Net Worth Over Time',
                                color: textColor
                            }, 
                            tooltip: { 
                                mode: 'index',
                                intersect: false,
                                callbacks: { 
                                    title: (context) => `Year ${context[0].label}`,
                                    label: (context) => (context.dataset.label || '') + ': ' + formatCurrency(context.parsed.y),
                                    afterBody: (context) => {
                                        if (context.length >= 2) {
                                            const buyingValue = context.find(item => item.dataset.label.includes('Buying'))?.parsed.y || 0;
                                            const rentingValue = context.find(item => item.dataset.label.includes('Renting'))?.parsed.y || 0;
                                            const delta = rentingValue - buyingValue;
                                            return `\nDelta (Rent - Buy): ${formatCurrency(delta)}`;
                                        }
                                        return '';
                                    }
                                }
                            }
                        } 
                    }
                });
            }
        }
        
        function updateDeltaChart(labels, deltaData) {
            const ctx = document.getElementById('deltaChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            
            if (deltaChart) {
                // Update existing chart data with animation
                deltaChart.data.labels = labels;
                deltaChart.data.datasets[0].data = deltaData;
                deltaChart.update('active');
            } else {
                // Create new chart with animation enabled
                deltaChart = new Chart(ctx, {
                    type: 'line', 
                    data: { 
                        labels, 
                        datasets: [{
                            label: 'Advantage (Rent - Buy)', 
                            data: deltaData, 
                            fill: true, 
                            tension: 0.1, 
                            segment: { 
                                borderColor: ctx => 'rgb(124, 58, 237, 0.8)', 
                                backgroundColor: ctx => ctx.p1.raw >= 0 ? 'rgba(59, 130, 246, 0.3)' : 'rgba(22, 163, 74, 0.3)', 
                            } 
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        animation: {
                            duration: 400,
                            easing: 'easeInOutQuad'
                        },
                        plugins: { 
                            legend: { 
                                display: false 
                            }, 
                            title: { 
                                display: true, 
                                text: 'Net Worth Advantage (Positive = Renting is Better)',
                                color: textColor
                            }, 
                            tooltip: { 
                                callbacks: { 
                                    title: (context) => `Year ${context[0].label}`,
                                    label: (context) => {
                                        const value = context.parsed.y;
                                        const interpretation = value >= 0 ? '(Renting is better)' : '(Buying is better)';
                                        return `Net Worth Advantage: ${formatCurrency(value)} ${interpretation}`;
                                    }
                                } 
                            } 
                        }, 
                        scales: { 
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            y: { 
                                ticks: { 
                                    color: textColor,
                                    callback: (value) => formatCurrency(value) 
                                }, 
                                grid: { 
                                    color: (c) => c.tick.value === 0 ? (isDark ? '#6b7280' : '#374151') : gridColor, 
                                    lineWidth: (c) => c.tick.value === 0 ? 1.5 : 1, 
                                } 
                            } 
                        } 
                    }
                });
            }
        }

        function resetToDefaults() {
            // Reset all input sliders and number fields to default values
            Object.keys(inputsConfig).forEach(id => {
                const config = inputsConfig[id];
                const slider = el(`${id}-slider`);
                const number = el(`${id}-number`);
                if (slider && number) {
                    slider.value = config.value;
                    number.value = config.value;
                }
            });
            
            // Reset radio buttons to default values
            const maintenanceBasisCurrent = document.querySelector('input[name="maintenanceBasis"][value="current"]');
            const investmentTaxTaxable = document.querySelector('input[name="investmentTax"][value="taxable"]');
            
            if (maintenanceBasisCurrent) maintenanceBasisCurrent.checked = true;
            if (investmentTaxTaxable) investmentTaxTaxable.checked = true;
            
            // Clear localStorage
            clearLocalStorage();
            
            // Recalculate results with default values
            calculateResults();
        }

        // --- Event Listeners & Initial Load ---
        toggleDetailsButton.addEventListener('click', () => { const isHidden = detailsSection.classList.toggle('hidden'); detailsArrow.textContent = isHidden ? 'â–¼' : 'â–²'; });
        toggleYearlyDataButton.addEventListener('click', () => { const isHidden = yearlyDataSection.classList.toggle('hidden'); yearlyDataArrow.textContent = isHidden ? 'â–¼' : 'â–²'; });
        exportCsvButton.addEventListener('click', exportToCsv);
        resetButton.addEventListener('click', resetToDefaults);
        
        // Theme toggle event listener
        document.getElementById('themeToggle').addEventListener('change', toggleTheme);

        window.onload = () => {
            // Initialize theme before anything else
            initializeTheme();
            
            Object.keys(inputsConfig).forEach(id => createSliderInput(id, inputsConfig[id]));
            setupInputListeners();
            
            // Load saved values from localStorage
            const savedValues = loadFromLocalStorage();
            if (savedValues) {
                applyStoredValues(savedValues);
            }
            
            calculateResults();
        };
    </script>
</body>
</html>
